---
title: BGP学习
date: 2020-02-10 22:07:37
tags: ['网络','BGP']
---


# 自制系统（Autonomous System，AS）
AS号范围：1-65535，其中，64512-65535属于私有AS号

# BGP相关特性
* BGP报文是基于TCP端口号179。
* 是单播建立邻居（手工指邻居）。没有组播和广播
> 注：由于BGP报文是基于TCP端口号179的，也就是BGP协议是一个三层之上的协议，说明BGP的邻居建立是不需要直连的，两个BGP对等体之间只要能TCP协议可达，且179端口号没有被占用的话，则就可以建立邻居. 一个运行了BGP协议的路由器也就是一直在监听这个179端口号
* 支持VLSM,CIDR
* 以AS为单位的路径矢量属性的路由协议
* 会话开始的时候会发送整张路由表,以后会触发更新[触发式增量更新]
* 有丰富的路径属性,简单的路由算法

# BGP基本配置及邻居建立
BGP有两种类型的邻居关系: EBGP(不同AS之间的邻居关系)和IBGP(一个AS内的邻居关系)


## EBGP

假设有两台路由器分别属于两个AS, 路由器1在AS-100中,路由器2在AS-101中, 这两个路由器相连的端口地址分别是12.1.1.1(路由器1)和 12.1.1.2(路由器2)(12.1.1.0/24)

路由器1配置
```

router bgp 100 #  router bgp AS号 指定这个路由器所在的AS号

bgp router-id id号   # 指定router-id,通常是loopback地址

neighbor 12.1.1.2 remote-as 101 # neighbor 对端地址 remote-as AS号   指定邻居, 还得标注对等体所在的AS号,从而能知道是使用EBGP还是IBGP

```
路由器2使用同样的配置

检验BGP是否已经起来,使用
```
show ip bgp summary

# 打印出来后,有一个TblVer列,这列说明当路由表发生变化时,则版本会加1
```
还可以使用
```
show tcp brief #查看179端口 TCP是否已经建立
```


如果使用loopback地址建立邻居的时候,需要特别注意的是,要设置**多跳特性**.因为默认情况下,EBGP的跳数为1,(而IBGP的默认跳数是255跳)因此,需要设置跳数大于1.比如设置成2,如下:

```
neighbor 对端loopback地址 ebgp-muiltihop 2
```


而且如果使用loopback地址建立邻居的话,还需要更新源
```
neighbor 新的地址  remote-as AS号
neighbor 新的地址 update-source 端口标识(如 loopback 1) 
```



## IBGP

IBGP建立不需要直连,只要两端的TCP 179端口 通就可以

假设在AS-101中有两台路由器,一台是路由器2(上面的路由器2),一台是路由器3,一台是路由器5.其中,路由器2和路由器5没有直连,而是通过路由器3连接.

路由器2和路由器3直连(23.1.1.0/24):
> 路由器2的地址:23.1.1.2 
>
> 路由器3的地址:23.1.1.3

路由器3和路由器5直连(35.1.1.0/24):
> 路由器3的地址:35.1.1.3
>
> 路由器5的地址:35.1.1.5


因此,如果路由器2和路由器5之间要建立IBGP的话,前提条件是要保障路由器2和路由器5是三层可达的.可以使用动态路由或者静态路由保证可达.

如果是静态路由的话,在路由器2上配置一条静态路由
```
ip route 35.1.1.0 255.255.255.0 23.1.1.3
```
路由器5上配置静态路由
```
ip route 23.1.1.0 255.255.255.0 35.1.1.3
```

三层可达之后,就可以使用上面EBGP的命令去建立邻居关系


更新邻居建立的端口地址可以使用
```
neighbor 新的地址  remote-as AS号
neighbor 新的地址 update-source 端口标识(如 loopback 1) 
# 两个命令一起使用,先指定对端的as号,然后再两个对等体地址更新
```
## 问题1:
> 问题:RIP协议是使用的是UDP的520端口,而BGP协议使用的是TCP的172端口,那么,如果使用RIP协议的单播模式,能否可以实现非直连,像IBGP一样
>
>答:不可以.因为虽然RIP也得需要三层可达,使用UDP协议.但是 RIP的跳数只能是1跳.因此,只能直连,而IBGP的默认跳数是255跳.EBGP的默认跳数是1跳.但是,BGP的跳数是可以修改的,但是RIP的跳数是不能修改的.因此,RIP协议只能直连








